/**
 * 会話中のテキストや画像のオブジェクト    
 * 将来的に別ファイルに置き換え予定
 */
const storyData = [
    {
        "scene": "conversation",
        "bgm": "../../music/bgm/なんでしょう？.mp3",
        "bgimg": "url(../../img/background/pc_room_evening.jpg)",
        "content": [
            {
                "title": "あなた",
                "text": "・・・あれ！？ゲームにもどらないぞ？なんでだろう",
                "main-person": "",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "",
            },
            {
                "title": "あなた",
                "text": "もう一度ゲームを起動してみるかぁ",
                "main-person": "",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "",
            },
            {
                "title": "あなた",
                "text": "あれ！ゲームに入れない！！IDもパスワードもあってるのになんで・・・！！",
                "main-person": "",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "<img src='../../img/other/dragon_hunter.svg' style='height: 90vh;'>",
            },
        ],
    },
    {
        "scene": "conversation",
        "bgm": "../../music/bgm/なんでしょう？.mp3",
        "bgimg": "url(../../img/background/pc_room_night.jpg)",
        "content": [
            {
                "title": "",
                "text": "～　数時間後　～",
                "main-person": "",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "",
            },
            {
                "title": "あなた",
                "text": "（プルルルル）<br>アキラから電話だ・・・",
                "main-person": "<img src='../../img/people/you.svg'>",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "",
            },
            {
                "title": "アキラ",
                "text": "おい！おまえ一体どういうことだよ！！",
                "main-person": "",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "<img src='../../img/other/phone.svg' style='height: 60vh;'>",
            },
            {
                "title": "あなた",
                "text": "うわぁっ！？どうしたのさ？",
                "main-person": "<img src='../../img/people/you.svg'>",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "",
            },
            {
                "title": "アキラ",
                "text": "どうもこうもないよ！さっきゲームでオレの悪口言ったろ！",
                "main-person": "",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "<img src='../../img/other/phone.svg' style='height: 60vh;'>",
            },
            {
                "title": "あなた",
                "text": "え！？言ってないよ！（しかも、今ゲームに入れないし・・・）",
                "main-person": "<img src='../../img/people/you.svg'>",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "",
            },
            {
                "title": "アキラ",
                "text": "もうフレンド消したからな！！友達もやめるからッ！！！",
                "main-person": "",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "<img src='../../img/other/phone.svg' style='height: 60vh;'>",
            },
            {
                "title": "あなた",
                "text": "え！なんでさ！！！<br>・・・きれちゃった",
                "main-person": "<img src='../../img/people/you.svg'>",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "",
            },
            {
                "title": "あなた",
                "text": "(どうしてこんなことになったんだろう？）",
                "main-person": "<img src='../../img/people/you.svg'>",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "",
            },
            {
                "title": "あなた",
                "text": "あいかわらず、ゲームには入れないなぁ・・・",
                "main-person": "",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "<img src='../../img/other/dragon_hunter.svg' style='height: 90vh;'>",
            },
            {
                "title": "？？？",
                "text": "あーあ・・・<br>大変なことになっちゃったね・・・",
                "main-person": "",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "<img src='../../img/nyateracy/nyateracy_1.svg'>",
            },
            {
                "title": "あなた",
                "text": "えっだれ！？<br>パソコンの中に・・・黒いネコ？？",
                "main-person": "<img src='../../img/people/you.svg'>",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "",
            },
            {
                "title": "ニャテラシー",
                "text": "ボクはニャテラシー！<br>時がもどせるふしぎなネコちゃんさ♪",
                "main-person": "",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "<img src='../../img/nyateracy/nyateracy_1.svg'>",
            },
            {
                "title": "あなた",
                "text": "時を戻せるだって？？<br>ありえないよ！そんなの！",
                "main-person": "<img src='../../img/people/you.svg'>",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "",
            },
            {
                "title": "ニャテラシー",
                "text": "パソコンの中からしゃべってくる黒ネコのほうがありえないとおもうよー",
                "main-person": "",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "<img src='../../img/nyateracy/nyateracy_1.svg'>",
            },
            {
                "title": "あなた",
                "text": "たしかに・・・",
                "main-person": "<img src='../../img/people/you.svg'>",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "",
            },
            {
                "title": "ニャテラシー",
                "text": "キミは今回「のっとりひがい」にあい、そのせいでアキラ君とケンカになった。",
                "main-person": "",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "<img src='../../img/nyateracy/nyateracy_1.svg'>",
            },
            {
                "title": "ニャテラシー",
                "text": "何がいけなかったのか考えてみて！ボクがその時間にもどしてあげる！",
                "main-person": "",
                "secondary-person": "",
                "tertiary-person": "",
                "back-img": "",
            },
        ],
    }
]

/**
 * シーン番号
 * @type {Number}
 */
let sceneId = 0;

/**
 * 文の番号
 * @type {Number}
 */
let sentenceId = 0;

/**
 * 文の数
 * @type {Number}
 */
let sentenceLength = 0;

/**
 * 隠し要素の切り替えを行う関数
 * @param {string} scene 
 */
const changeHidden = (scene) => {
    if (scene == "opening") {
        $('#opening-wrapper').show();
        $('#conversation-wrapper').hide();
        $('#people-wrapper').hide();
        $('#back-wrapper').hide();
        $('#darkness-wrapper').hide();
    } else if (scene == "conversation") {
        $('#opening-wrapper').hide();
        $('#conversation-wrapper').show();
        $('#people-wrapper').show();
        $('#back-wrapper').show();
        $('#darkness-wrapper').hide();
    }
}

/**
 * オープニングのテキストや画像を表示する関数
 * @returns {undefined}
 */
const showOpening = () => {
    $('body').css('backgroundImage', storyData[sceneId].bgimg)
    $('#chapter-number').html(storyData[sceneId]["chapter-number"]);
    $('#chapter-title').html(storyData[sceneId]["chapter-title"]);
}

/**
 * 会話中のテキストや画像を表示する関数
 * @returns {undefined}
 */
const showConversation = () => {
    $('#title').html(storyData[sceneId].content[sentenceId].title);
    $('#text').html(storyData[sceneId].content[sentenceId].text);
    $('#main-person').html(storyData[sceneId].content[sentenceId]["main-person"]);
    $('#secondary-person').html(storyData[sceneId].content[sentenceId]["secondary-person"]);
    $('#tertiary-person').html(storyData[sceneId].content[sentenceId]["tertiary-person"]);
    $('#back-img').html(storyData[sceneId].content[sentenceId]["back-img"]);
}

/**
 * ローディング後に、オープニングのテキストや画像を表示
 */
$(window).on('load', function () { // 全ての読み込みが完了したら実行
    $('#loading').delay(1000).fadeOut(1000);
    changeHidden("conversation");
    sentenceLength = storyData[sceneId].content.length;
    $('body').css('backgroundImage', storyData[sceneId].bgimg)
    $('#bgm source').attr('src', storyData[sceneId].bgm);
    document.querySelector("#bgm").load();
    $('#bgm').get(0).play();
    showConversation();
});
    
/**
 * 10秒たったら強制的にロード画面を非表示
 */
$(() => {
    setTimeout(() => {
        $('#loading').delay(1000).fadeOut(1000);
    }, 10000);
});

/**
 * シーンが進む際の処理をする関数
 */
const sceneAdvance = () => {
    sceneId++;
    if (storyData[sceneId].scene == "conversation") {
        
        // 暗転
        $('#darkness-wrapper').show().animate({'opacity': 1}, 500, 'swing', () => {
            sentenceLength = storyData[sceneId].content.length;
            sentenceId = 0;

            // 暗転中に場面を切り替える
            changeHidden("conversation");
            $('body').css('backgroundImage', storyData[sceneId].bgimg)
            $('#bgm source').attr('src', storyData[sceneId].bgm);
            document.querySelector("#bgm").load();
            $('#bgm').get(0).play();
            showConversation();

            // 明転
            $('#darkness-wrapper').animate({'opacity': 0}, 500, 'swing', () => {
                $('#darkness-wrapper').hide();
            });
        })
    }
}

/**
 * オープニングラッパーを押したときに遷移するイベントハンドラ
 */
$('#opening-wrapper').on("click", () => {
    sceneAdvance();
});

/**
 * 進むボタンを押したときにテキストや画像を表示するイベントハンドラ
 */
$('#forward').on("click", () => {
    if ((sceneId == 2) && (sentenceId == sentenceLength - 1)) {
        location.replace("../html/mission.html");
        return;
    }
    if (sentenceId < sentenceLength - 1) {
        makeSound();
        sentenceId++;
        showConversation();
        return;
    }
    if (sentenceId == sentenceLength - 1) {
        makeSound();
        sceneAdvance();
        return;
    }
});

/**
 * 戻るボタンを押したときにテキストや画像を表示するイベントハンドラ
 */
$('#backward').on("click", () => {
    if (sentenceId > 0) {
        makeSound();
        sentenceId--;
        showConversation();
    }
});

/**
 * 効果音
 * @type {HTMLElement}
 */
const soundEffect = document.getElementById("sound-effect");

/**
 * 効果音を鳴らす関数
 * @returns {undefined}
 */
const makeSound = () => {
    soundEffect.pause();
    soundEffect.currentTime = 0;
    soundEffect.play();
}